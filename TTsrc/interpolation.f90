MODULE interpolation
!!=================================================================================
!!
!!    lagrange interpolation and its varietas
!!
!!  notice:
!!      outlier is equal to boundary.
!!
!!    Record of revision:
!!           Date:              Programmer:              Description of change:
!!     ------------           --------------            ------------------------
!!     2017.10.29                   Hanrui                 NV2.0 original code
!!                                                          checked with TTini
!!     2018.03.28                   Hanrui                 NV2.0 Final version
!!
!!=================================================================================
    IMPLICIT NONE

    !--------------------------------------------------------------------------
    PUBLIC          ::  SpheDistance
                    !   give spherical distance

    PUBLIC          ::  plane_2lagr
                    !   n=2 lagrange interpolation from plane A to plane B
                    !   first-order polynomial interpolation approximation(linear)
    PUBLIC          ::  line_2lagr
                    !   n=2 lagrange interpolation from line A to line B
                    !   first-order polynomial interpolation approximation(linear)

    PUBLIC          ::  plane_3lagr
                    !   n=3 lagrange interpolation from plane A to plane B
                    !   second-order polynomial interpolation approximation
    PUBLIC          ::  line_3lagr
                    !   n=3 lagrange interpolation from line A to line B
                    !   second-order polynomial interpolation approximation

    PUBLIC          ::  plane_4lagr
                    !   n=4 lagrange interpolation from plane A to plane B
                    !   third-order polynomial interpolation approximation
    PUBLIC          ::  line_4lagr
                    !   n=4 lagrange interpolation from line A to line B
                    !   third-order polynomial interpolation approximation

    PUBLIC          ::  lagr
                    !   lagrange interpolation

    !--------------------------------------------------------------------------
    Contains

    !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
    !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
    !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
    !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
    !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!

    subroutine plane_2lagr( n1, n2, A, A1, A2, m1, m2, B1, B2, B )
    !!=========================================================================
    !!
    !!  lagrange interpolation from plane to plane
    !!  first-order polynomial interpolation approximation
    !!
    !!      A(n1, n2 ), dim_axis : A1(n1), A2(n2)
    !!      B(m1. m2 ), dim_axis : B1(m1), B1(m2)
    !!
    !!  notice:
    !!      A1(m1) B1(m1) ranking by size
    !!      A2(m2) B2(m2) ranking by size
    !!
    !!
    !!                                                    rui 2018/01/08
    !!
    !!=========================================================================

        implicit none 
        !------------------------------------------------------------------

            !----------------------------------------------------------
            integer,intent(in)          ::  n1
            integer,intent(in)          ::  n2
            real(8),intent(in)          ::  A(n1, n2)
            real(8),intent(in)          ::  A1(n1)
            real(8),intent(in)          ::  A2(n2)
            integer,intent(in)          ::  m1
            integer,intent(in)          ::  m2
            real(8),intent(in)          ::  B1(m1)
            real(8),intent(in)          ::  B2(m2)
            real(8),intent(out)         ::  B(m1, m2)

            real(8)                     ::  Atmp(m1, n2)

            integer                     ::  ii, jj, kk
            integer                     ::  i,  j,  k


            !----------------------------------------------------------

        !------------------------------------------------------------------

            !----------------------------------------------------------

            do ii=1,n2
                call line_2lagr( n1, A(:,ii), A1(:), m1, B1(:), Atmp(:,ii) )
            enddo

            do jj=1,m1
                call line_2lagr( n2, Atmp(jj,:), A2(:), m2, B2(:), B(jj,:) )
            enddo

            return
            !----------------------------------------------------------

        !------------------------------------------------------------------

    !!=========================================================================
    end subroutine plane_2lagr

    !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
    !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
    !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
    !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
    !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!

    subroutine line_2lagr( n, A, A1, m, B1, B )
    !!=========================================================================
    !!
    !!  lagrange interpolation from line to line
    !!  first-order polynomial interpolation approximation
    !!
    !!      A(n),dim_axis : A1(n)
    !!      B(m),dim_axis : B1(m)
    !!
    !!  notice:
    !!      A1(m) B1(m) ranking by size
    !!
    !!          .     .             .      .      .
    !!          1     2      3      4      5      6
    !!      - - +-----+------+------+------+------+ - - 
    !!       .     .      .      .      .      .     .
    !!       123   123    234    345    456    456   456
    !!
    !!                                                    rui 2018/01/08
    !!
    !!=========================================================================

        implicit none 
        !------------------------------------------------------------------

            !----------------------------------------------------------
            integer,intent(in)          ::  n
            real(8),intent(in)          ::  A(n)
            real(8),intent(in)          ::  A1(n)
            integer,intent(in)          ::  m
            real(8),intent(in)          ::  B1(m)
            real(8),intent(out)         ::  B(m)

            real(8)                     ::  AA(2)
            real(8)                     ::  AA1(2)
            integer                     ::  stpoint

            integer                     ::  ii, jj, kk
            integer                     ::  i,  j,  k

            !----------------------------------------------------------

        !------------------------------------------------------------------

            !----------------------------------------------------------

            B = 0.0d0

            do i=1,m

                !write(*,*) i
                !    .     .             .      .      .
                !    1     2      3      4      5      6
                !- - +-----+------+------+------+------+ - - 
                ! .     .      .      .      .      .     .
                ! 123   123    234    345    456    456   456

                if( B1(i) .le. A1(1) ) then
                    B(i) = A(1)
                    !stpoint = 1
                elseif( B1(i) .gt. A1(n) ) then
                    B(i) = A(n)
                    !stpoint = n-2
                else
                    !inner interpolation
                    do j=1,n-1
                        if( B1(i).gt.A1(j) .and. B1(i).le.A1(j+1) ) then
                            stpoint = j
                            AA1(:) = A1(stpoint:stpoint+1)
                            AA(:)  = A(stpoint:stpoint+1)
                            call lagr(2, AA1, AA, B1(i), B(i))
                            exit
                        endif
                   enddo
                endif

            enddo

            return
            !----------------------------------------------------------

        !------------------------------------------------------------------

    !!=========================================================================
    end subroutine line_2lagr

    !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
    !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
    !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
    !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
    !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!

    subroutine plane_3lagr( n1, n2, A, A1, A2, m1, m2, B1, B2, B )
    !!=========================================================================
    !!
    !!  lagrange interpolation from plane to plane
    !!  second-order polynomial interpolation approximation
    !!
    !!      A(n1, n2 ), dim_axis : A1(n1), A2(n2)
    !!      B(m1. m2 ), dim_axis : B1(m1), B1(m2)
    !!
    !!  notice:
    !!      A1(m1) B1(m1) ranking by size
    !!      A2(m2) B2(m2) ranking by size
    !!
    !!
    !!                                                    rui 2018/01/08
    !!
    !!=========================================================================

        implicit none 
        !------------------------------------------------------------------

            !----------------------------------------------------------
            integer,intent(in)          ::  n1
            integer,intent(in)          ::  n2
            real(8),intent(in)          ::  A(n1, n2)
            real(8),intent(in)          ::  A1(n1)
            real(8),intent(in)          ::  A2(n2)
            integer,intent(in)          ::  m1
            integer,intent(in)          ::  m2
            real(8),intent(in)          ::  B1(m1)
            real(8),intent(in)          ::  B2(m2)
            real(8),intent(out)         ::  B(m1, m2)

            real(8)                     ::  Atmp(m1, n2)

            integer                     ::  ii, jj, kk
            integer                     ::  i,  j,  k


            !----------------------------------------------------------

        !------------------------------------------------------------------

            !----------------------------------------------------------

            do ii=1,n2
                call line_3lagr( n1, A(:,ii), A1(:), m1, B1(:), Atmp(:,ii) )
            enddo

            do jj=1,m1
                call line_3lagr( n2, Atmp(jj,:), A2(:), m2, B2(:), B(jj,:) )
            enddo

            return
            !----------------------------------------------------------

        !------------------------------------------------------------------

    !!=========================================================================
    end subroutine plane_3lagr

    !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
    !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
    !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
    !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
    !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!

    subroutine line_3lagr( n, A, A1, m, B1, B )
    !!=========================================================================
    !!
    !!  lagrange interpolation from line to line
    !!  second-order polynomial interpolation approximation
    !!
    !!      A(n),dim_axis : A1(n)
    !!      B(m),dim_axis : B1(m)
    !!
    !!  notice:
    !!      A1(m) B1(m) ranking by size
    !!
    !!          .     .             .      .      .
    !!          1     2      3      4      5      6
    !!      - - +-----+------+------+------+------+ - - 
    !!       .     .      .      .      .      .     .
    !!       123   123    234    345    456    456   456
    !!
    !!                                                    rui 2018/01/08
    !!
    !!=========================================================================

        implicit none 
        !------------------------------------------------------------------

            !----------------------------------------------------------
            integer,intent(in)          ::  n
            real(8),intent(in)          ::  A(n)
            real(8),intent(in)          ::  A1(n)
            integer,intent(in)          ::  m
            real(8),intent(in)          ::  B1(m)
            real(8),intent(out)         ::  B(m)

            real(8)                     ::  AA(3)
            real(8)                     ::  AA1(3)
            integer                     ::  stpoint

            integer                     ::  ii, jj, kk
            integer                     ::  i,  j,  k

            !----------------------------------------------------------

        !------------------------------------------------------------------

            !----------------------------------------------------------

            B = 0.0d0

            do i=1,m

                !write(*,*) i
                !    .     .             .      .      .
                !    1     2      3      4      5      6
                !- - +-----+------+------+------+------+ - - 
                ! .     .      .      .      .      .     .
                ! 123   123    234    345    456    456   456

                if( B1(i) .le. A1(1) ) then
                    B(i) = A(1)
                    !stpoint = 1
                elseif( B1(i) .gt. A1(n) ) then
                    B(i) = A(n)
                    !stpoint = n-2
                else
                    !inner interpolation
                    do j=1,n-1
                        if( B1(i).gt.A1(j) .and. B1(i).le.A1(j+1) ) then
                            stpoint = j
                            if( j+2 .gt. n ) stpoint = j-1
                            AA1(:) = A1(stpoint:stpoint+2)
                            AA(:)  = A(stpoint:stpoint+2)
                            call lagr(3, AA1, AA, B1(i), B(i))
                            exit
                        endif
                   enddo
                endif

            enddo

            return
            !----------------------------------------------------------

        !------------------------------------------------------------------

    !!=========================================================================
    end subroutine line_3lagr

    !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
    !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
    !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
    !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
    !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!

    subroutine plane_4lagr( n1, n2, A, A1, A2, m1, m2, B1, B2, B )
    !!=========================================================================
    !!
    !!  lagrange interpolation from plane to plane
    !!  third-order polynomial interpolation approximation
    !!
    !!      A(n1, n2 ), dim_axis : A1(n1), A2(n2)
    !!      B(m1. m2 ), dim_axis : B1(m1), B1(m2)
    !!
    !!  notice:
    !!      A1(m1) B1(m1) ranking by size
    !!      A2(m2) B2(m2) ranking by size
    !!
    !!
    !!                                                    rui 2018/01/08
    !!
    !!=========================================================================

        implicit none 
        !------------------------------------------------------------------

            !----------------------------------------------------------
            integer,intent(in)          ::  n1
            integer,intent(in)          ::  n2
            real(8),intent(in)          ::  A(n1, n2)
            real(8),intent(in)          ::  A1(n1)
            real(8),intent(in)          ::  A2(n2)
            integer,intent(in)          ::  m1
            integer,intent(in)          ::  m2
            real(8),intent(in)          ::  B1(m1)
            real(8),intent(in)          ::  B2(m2)
            real(8),intent(out)         ::  B(m1, m2)

            real(8)                     ::  Atmp(m1, n2)

            integer                     ::  ii, jj, kk
            integer                     ::  i,  j,  k


            !----------------------------------------------------------

        !------------------------------------------------------------------

            !----------------------------------------------------------

            do ii=1,n2
                call line_4lagr( n1, A(:,ii), A1(:), m1, B1(:), Atmp(:,ii) )
            enddo

            do jj=1,m1
                call line_4lagr( n2, Atmp(jj,:), A2(:), m2, B2(:), B(jj,:) )
            enddo

            return
            !----------------------------------------------------------

        !------------------------------------------------------------------

    !!=========================================================================
    end subroutine plane_4lagr

    !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
    !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
    !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
    !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
    !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!

    subroutine line_4lagr( n, A, A1, m, B1, B )
    !!=========================================================================
    !!
    !!  lagrange interpolation from line to line
    !!  third-order polynomial interpolation approximation
    !!
    !!      A(n),dim_axis : A1(n)
    !!      B(m),dim_axis : B1(m)
    !!
    !!  notice:
    !!      A1(m) B1(m) ranking by size
    !!
    !!          .     .             .      .      .
    !!          1     2      3      4      5      6
    !!      - - +-----+------+------+------+------+ - - 
    !!       .     .      .      .      .      .     .
    !!       123   123    234    345    456    456   456
    !!
    !!                                                    rui 2018/01/08
    !!
    !!=========================================================================

        implicit none 
        !------------------------------------------------------------------

            !----------------------------------------------------------
            integer,intent(in)          ::  n
            real(8),intent(in)          ::  A(n)
            real(8),intent(in)          ::  A1(n)
            integer,intent(in)          ::  m
            real(8),intent(in)          ::  B1(m)
            real(8),intent(out)         ::  B(m)

            real(8)                     ::  AA(4)
            real(8)                     ::  AA1(4)
            integer                     ::  stpoint

            integer                     ::  ii, jj, kk
            integer                     ::  i,  j,  k

            !----------------------------------------------------------

        !------------------------------------------------------------------

            !----------------------------------------------------------

            B = 0.0d0

            do i=1,m

                !write(*,*) i
                !    .     .             .      .      .
                !    1     2      3      4      5      6
                !- - +-----+------+------+------+------+ - - 
                ! .     .      .      .      .      .     .
                ! 123   123    234    345    456    456   456

                if( B1(i) .le. A1(1) ) then
                    B(i) = A(1)
                    !stpoint = 1
                elseif( B1(i) .gt. A1(n) ) then
                    B(i) = A(n)
                    !stpoint = n-3
                else
                    !inner interpolation
                    do j=1,n-1
                        if( B1(i).gt.A1(j) .and. B1(i).le.A1(j+1) ) then
                            stpoint = j
                            if( j+3 .eq. n+2 ) stpoint = j-2
                            if( j+3 .eq. n+1 ) stpoint = j-1
                            AA1(:) = A1(stpoint:stpoint+3)
                            AA(:)  = A(stpoint:stpoint+3)
                            call lagr(4, AA1, AA, B1(i), B(i))
                            exit
                        endif
                   enddo
                endif

            enddo

            return
            !----------------------------------------------------------

        !------------------------------------------------------------------

    !!=========================================================================
    end subroutine line_4lagr

    !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
    !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
    !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
    !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
    !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!

    subroutine lagr(n, p, v, Pf, Vf)
    !!=========================================================================
    !!
    !!  lagrange interpolation
    !!
    !!      1       2       3        n-2     n-1      n
    !!      *       *       *   ...   *       *       *
    !!     p 1     p 2     p 3     p n-2   p n-1    p n
    !!     v 1     v 2     v 3     v n-2   v n-1    v n
    !!                  ^
    !!                  Pf
    !!                  Vf (out)
    !!
    !!                                                    rui 2018/01/08
    !!
    !!=========================================================================

        implicit none 
        !------------------------------------------------------------------

            !----------------------------------------------------------
            integer,intent(in)      ::  n
            real(8),intent(in)      ::  p(n),v(n)
            real(8),intent(in)      ::  Pf
            real(8),intent(out)     ::  Vf
            real(8)                 ::  lagr_coef

            integer                     ::  ii, jj, kk
            integer                     ::  i,  j,  k

            !----------------------------------------------------------

        !------------------------------------------------------------------

            !----------------------------------------------------------
            Vf = 0.0d0

            do ii=1,n

                lagr_coef = 1.0d0
                !   lagrange interpolation coefficient of each term

                do jj=1,n
                    if( p(ii) .eq. p(jj) ) cycle
                    !   caculate coefficient without the jjth
                    !   page 464 Fortran95 peng
                    lagr_coef = lagr_coef * (Pf-p(jj))/(p(ii)-p(jj))
                enddo

                Vf = Vf + v(ii) * lagr_coef

            enddo

            return
            !----------------------------------------------------------

        !------------------------------------------------------------------

    !!=========================================================================
    end subroutine lagr

    !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
    !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
    !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
    !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
    !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!

    function SpheDistance(lon1,lat1,lon2,lat2)
    !!=========================================================================
    !!
    !!  give spherical distance 
    !!
    !!=========================================================================

        use common,     only     :  Rearth, PI
        implicit none 
        !------------------------------------------------------------------

            !----------------------------------------------------------
            real(8),intent(in)   ::  lon1,lat1,lon2,lat2
            real(8)              ::  x1,x2,y1,y2
            real(8)              ::  SpheDistance
            !----------------------------------------------------------

        !------------------------------------------------------------------

            !----------------------------------------------------------
            !   angle to radian
            y1 = lat1 * PI / 180.0d0
            y2 = lat2 * PI / 180.0d0
            x1 = lon1 * PI / 180.0d0
            x2 = lon2 * PI / 180.0d0
            if((x1.eq.x2).and.(y1.eq.y2)) then
            SpheDistance = 0.0d0
            else
            SpheDistance = Rearth * acos(cos(y1)*cos(y2)*cos(x1-x2)+sin(y1)*sin(y2))
            endif
            !SpheDistance=sqrt(SpheDistance**2.0+(lev1-lev2)**2.0)
            if(SpheDistance.lt.0.0d0) then
                write(*,*) "wrong in SpheDistance! check points 01"
            endif
            !----------------------------------------------------------
            return
        !------------------------------------------------------------------

    !!=========================================================================
    end function SpheDistance

    !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
    !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
    !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
    !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
    !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!

!==================================================================================
end MODULE interpolation
